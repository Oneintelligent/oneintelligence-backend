#!/usr/bin/env bash
set -euo pipefail

# ---------------------------------------------
# ğŸš€ OneIntelligence Backend EC2 Deployment Script (Ubuntu 22.04+)
# ---------------------------------------------
# Usage:
#   curl -sSL https://your/location/deploy_oneintelligence.sh -o deploy_oneintelligence.sh
#   chmod +x deploy_oneintelligence.sh
#   ./deploy_oneintelligence.sh
#
# Notes:
#  - Run as ubuntu user (script uses sudo internally)
#  - Ensure AWS Security Group allows inbound 80 and 22
#  - Database password will be auto-generated if not exists
# ---------------------------------------------

PROJECT_NAME="oneintelligence-backend"
PROJECT_DIR="/home/ubuntu/${PROJECT_NAME}"
REPO_URL="https://github.com/Oneintelligent/oneintelligence-backend.git"
DB_NAME="oneintelligence-db"
DB_USER="oneintelligence"
DJANGO_SETTINGS_MODULE="config.settings"
STATIC_DIR="${PROJECT_DIR}/static"
GUNICORN_SERVICE="/etc/systemd/system/gunicorn.service"
NGINX_CONF="/etc/nginx/sites-available/${PROJECT_NAME}"
ENV_FILE="${PROJECT_DIR}/.env"

echo "ğŸŒ Starting deployment for ${PROJECT_NAME} ..."

# --- Step 0: System Update ---
echo "ğŸ”„ Updating OS packages..."
sudo apt update -y && sudo apt upgrade -y

# --- Step 1: Install Required Packages ---
echo "ğŸ“¦ Installing required packages..."
sudo apt install -y python3 python3-pip python3-venv postgresql postgresql-contrib git curl nginx ufw redis-server openssl

# --- Step 2: Setup PostgreSQL and Redis ---
echo "ğŸ—„ï¸  Ensuring PostgreSQL & Redis are running..."
sudo systemctl enable --now postgresql
sudo systemctl enable --now redis-server

# Get or generate database password
if [ -f "${ENV_FILE}" ] && grep -q "^DB_PASSWORD=" "${ENV_FILE}"; then
    DB_PASS=$(grep "^DB_PASSWORD=" "${ENV_FILE}" | cut -d'=' -f2-)
    echo "âœ… Using existing DB password from .env"
else
    DB_PASS=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
    echo "ğŸ” Generated new secure DB password"
fi

# Create DB user if missing
if ! sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='${DB_USER}'" | grep -q 1; then
    echo "ğŸ” Creating PostgreSQL user ${DB_USER}..."
    sudo -u postgres psql -c "CREATE USER ${DB_USER} WITH PASSWORD '${DB_PASS}';"
else
    echo "âœ… PostgreSQL user ${DB_USER} already exists."
    # Update password if it changed
    sudo -u postgres psql -c "ALTER USER ${DB_USER} WITH PASSWORD '${DB_PASS}';" 2>/dev/null || true
fi

# Create DB if missing
if ! sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='${DB_NAME}'" | grep -q 1; then
    echo "ğŸ—ƒï¸  Creating database ${DB_NAME}..."
    sudo -u postgres createdb "${DB_NAME}" -O "${DB_USER}"
else
    echo "âœ… Database ${DB_NAME} already exists."
fi

# --- Step 3: Clone or Update Repo ---
if [ ! -d "${PROJECT_DIR}" ]; then
    echo "ğŸ“¦ Cloning repository into ${PROJECT_DIR}..."
    git clone "${REPO_URL}" "${PROJECT_DIR}"
else
    echo "ğŸ” Updating repository in ${PROJECT_DIR}..."
    cd "${PROJECT_DIR}"
    # stash local uncommitted changes if any (best-effort)
    if ! git diff-index --quiet HEAD --; then
        echo "âš ï¸  Uncommitted changes detected â€” stashing..."
        git stash push -m "Auto-stash before deploy $(date -u +%Y%m%d_%H%M%S)" || true
    fi
    
    # Improved Git error handling
    if ! git fetch origin; then
        echo "âŒ Failed to fetch from origin. Check network and repository access."
        exit 1
    fi
    
    if ! git checkout main; then
        echo "âŒ Failed to checkout main branch."
        exit 1
    fi
    
    if ! git pull --ff-only origin main; then
        echo "âš ï¸  Fast-forward pull failed. Attempting merge..."
        if ! git pull origin main; then
            echo "âŒ Failed to pull latest changes."
            exit 1
        fi
    fi
fi
cd "${PROJECT_DIR}"

# --- Step 4: Setup Python Virtual Environment ---
if [ ! -d "${PROJECT_DIR}/venv" ]; then
    echo "ğŸ Creating Python virtual environment..."
    python3 -m venv "${PROJECT_DIR}/venv"
else
    echo "âœ… Virtual environment already exists."
fi

# shellcheck disable=SC1090
source "${PROJECT_DIR}/venv/bin/activate"

# --- Step 5: Install Dependencies ---
echo "ğŸ“¥ Installing Python dependencies..."
pip install --upgrade pip setuptools wheel
if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
else
    pip install django djangorestframework psycopg2-binary drf-spectacular python-dotenv gunicorn
fi

# --- Step 6: Setup Environment Variables (.env file) ---
echo "ğŸ” Ensuring .env file exists and has required entries..."
PUBLIC_IP=$(curl -s http://checkip.amazonaws.com || echo "")

if [ ! -f "${ENV_FILE}" ]; then
    SECRET_KEY=$(openssl rand -hex 32)
    # Build ALLOWED_HOSTS with public IP if available
    ALLOWED_HOSTS_LIST="localhost,127.0.0.1"
    if [ -n "${PUBLIC_IP}" ] && [ "${PUBLIC_IP}" != "0.0.0.0" ]; then
        ALLOWED_HOSTS_LIST="${ALLOWED_HOSTS_LIST},${PUBLIC_IP}"
    fi
    
    cat > "${ENV_FILE}" <<EOF
# OneIntelligence environment variables - auto-generated
SECRET_KEY=${SECRET_KEY}
DEBUG=False
DB_NAME=${DB_NAME}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASS}
DB_HOST=localhost
DB_PORT=5432
# ALLOWED_HOSTS should be a comma-separated list of hostnames/IPs without ports
ALLOWED_HOSTS=${ALLOWED_HOSTS_LIST}
OPENAI_API_KEY=sk-placeholder-not-configured
REDIS_URL=redis://127.0.0.1:6379/1
EOF
    chmod 600 "${ENV_FILE}"
    sudo chown ubuntu:ubuntu "${ENV_FILE}"
    echo "âœ… .env created at ${ENV_FILE}. Edit ALLOWED_HOSTS and OPENAI_API_KEY as needed."
else
    # ensure minimal keys exist; do not overwrite existing values
    grep -q "^SECRET_KEY=" "${ENV_FILE}" || printf "SECRET_KEY=%s\n" "$(openssl rand -hex 32)" >> "${ENV_FILE}"
    grep -q "^DEBUG=" "${ENV_FILE}" || echo "DEBUG=False" >> "${ENV_FILE}"
    grep -q "^DB_NAME=" "${ENV_FILE}" || echo "DB_NAME=${DB_NAME}" >> "${ENV_FILE}"
    grep -q "^DB_USER=" "${ENV_FILE}" || echo "DB_USER=${DB_USER}" >> "${ENV_FILE}"
    grep -q "^DB_PASSWORD=" "${ENV_FILE}" || echo "DB_PASSWORD=${DB_PASS}" >> "${ENV_FILE}"
    grep -q "^DB_HOST=" "${ENV_FILE}" || echo "DB_HOST=localhost" >> "${ENV_FILE}"
    grep -q "^DB_PORT=" "${ENV_FILE}" || echo "DB_PORT=5432" >> "${ENV_FILE}"
    grep -q "^REDIS_URL=" "${ENV_FILE}" || echo "REDIS_URL=redis://127.0.0.1:6379/1" >> "${ENV_FILE}"
    grep -q "^OPENAI_API_KEY=" "${ENV_FILE}" || echo "OPENAI_API_KEY=sk-placeholder-not-configured" >> "${ENV_FILE}"
    
    # Auto-update ALLOWED_HOSTS with public IP if not present
    if [ -n "${PUBLIC_IP}" ] && [ "${PUBLIC_IP}" != "0.0.0.0" ]; then
        if grep -q "^ALLOWED_HOSTS=" "${ENV_FILE}"; then
            CURRENT_HOSTS=$(grep "^ALLOWED_HOSTS=" "${ENV_FILE}" | cut -d'=' -f2-)
            if [[ ! "$CURRENT_HOSTS" =~ "$PUBLIC_IP" ]]; then
                sudo sed -i "s/^ALLOWED_HOSTS=.*/ALLOWED_HOSTS=${CURRENT_HOSTS},${PUBLIC_IP}/" "${ENV_FILE}"
                echo "âœ… Added ${PUBLIC_IP} to ALLOWED_HOSTS"
            fi
        else
            echo "ALLOWED_HOSTS=localhost,127.0.0.1,${PUBLIC_IP}" >> "${ENV_FILE}"
            echo "âœ… Created ALLOWED_HOSTS with ${PUBLIC_IP}"
        fi
    else
        grep -q "^ALLOWED_HOSTS=" "${ENV_FILE}" || echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> "${ENV_FILE}"
    fi
    
    chmod 600 "${ENV_FILE}"
    sudo chown ubuntu:ubuntu "${ENV_FILE}"
    echo "âœ… .env updated (existing values preserved)."
fi

# --- Step 7: Migrations & Static Files ---
echo "ğŸ—„ï¸  Running Django migrations and collectstatic..."
export DJANGO_SETTINGS_MODULE="${DJANGO_SETTINGS_MODULE}"

# Safer .env loading
set +u
while IFS= read -r line; do
    # Skip comments and empty lines
    [[ "$line" =~ ^#.*$ ]] && continue
    [[ -z "$line" ]] && continue
    # Export variable
    export "$line" 2>/dev/null || true
done < "${ENV_FILE}"
set -u

mkdir -p "${STATIC_DIR}"
sudo chown -R ubuntu:www-data "${STATIC_DIR}"
sudo chmod -R 755 "${STATIC_DIR}"
python manage.py collectstatic --noinput || true
python manage.py migrate --noinput || true

# --- Step 8: Gunicorn systemd setup ---
echo "âš™ï¸ Ensuring Gunicorn systemd service exists and is configured..."
if [ ! -f "${GUNICORN_SERVICE}" ]; then
    sudo bash -c "cat > ${GUNICORN_SERVICE}" <<'UNIT_EOF'
[Unit]
Description=Gunicorn daemon for OneIntelligence Backend
After=network.target

[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/oneintelligence-backend
Environment="DJANGO_SETTINGS_MODULE=config.settings"
EnvironmentFile=/home/ubuntu/oneintelligence-backend/.env
UMask=007
ExecStart=/home/ubuntu/oneintelligence-backend/venv/bin/gunicorn \
    --workers 3 \
    --bind unix:/home/ubuntu/oneintelligence-backend/oneintelligence-backend.sock \
    --timeout 120 \
    --access-logfile - \
    --error-logfile - \
    config.wsgi:application
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
UNIT_EOF

    sudo systemctl daemon-reload
    sudo systemctl enable --now gunicorn
    echo "âœ… Gunicorn systemd service created and started."
else
    echo "âœ… Gunicorn service already present â€” will restart to pick up changes."
    sudo systemctl restart gunicorn || true
fi

# Ensure project directory and static files have correct ownership & perms
sudo chown -R ubuntu:www-data "${PROJECT_DIR}"
sudo chmod 750 /home/ubuntu
sudo chmod -R 750 "${PROJECT_DIR}"
if [ -d "${STATIC_DIR}" ]; then
    sudo chmod -R 755 "${STATIC_DIR}"
fi

# Wait for gunicorn to create socket with improved error handling
echo "â³ Waiting for Gunicorn socket to be created..."
SOCKET="${PROJECT_DIR}/${PROJECT_NAME}.sock"
MAX_WAIT=30
WAITED=0
while [ ! -S "${SOCKET}" ] && [ $WAITED -lt $MAX_WAIT ]; do
    sleep 1
    WAITED=$((WAITED + 1))
done

if [ ! -S "${SOCKET}" ]; then
    echo "âš ï¸  Socket not created after ${MAX_WAIT}s. Checking Gunicorn status..."
    sudo systemctl status gunicorn --no-pager -l || true
    echo "âš ï¸  Continuing, but socket permissions may need manual fix."
else
    echo "âœ… Socket found: ${SOCKET}"
    sudo chmod 770 "${SOCKET}"
    sudo chown ubuntu:www-data "${SOCKET}"
fi

# --- Step 9: NGINX Setup (server block + proxy headers + IPv4 listen) ---
echo "ğŸŒ Configuring Nginx site..."
if [ ! -f "${NGINX_CONF}" ]; then
    PUBLIC_IP=$(curl -s http://checkip.amazonaws.com || echo "0.0.0.0")
    sudo bash -c "cat > ${NGINX_CONF}" <<'NGINX_EOF'
server {
    listen 80 default_server;
    #listen [::]:80 default_server;

    server_name REPLACE_WITH_PUBLIC_IP localhost 127.0.0.1 _;

    location /static/ {
        alias /home/ubuntu/oneintelligence-backend/static/;
        expires 1y;
        access_log off;
        add_header Cache-Control "public, immutable";
    }

    location / {
        include proxy_params;
        proxy_pass http://unix:/home/ubuntu/oneintelligence-backend/oneintelligence-backend.sock;

        # Ensure required headers are set for Django
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 300;
        proxy_connect_timeout 300;
    }

    client_max_body_size 50M;
}
NGINX_EOF

    # replace placeholder server_name with actual public IP
    sudo sed -i "s/REPLACE_WITH_PUBLIC_IP/${PUBLIC_IP}/g" "${NGINX_CONF}"
    
    # Remove default site to prevent conflicts
    if [ -f /etc/nginx/sites-enabled/default ]; then
        sudo rm /etc/nginx/sites-enabled/default
        echo "âœ… Removed default Nginx site"
    fi
    
    sudo ln -sf "${NGINX_CONF}" /etc/nginx/sites-enabled/
    echo "âœ… Nginx site created and enabled."
else
    echo "âœ… Nginx configuration already exists; ensuring required lines are present..."
    # Ensure default_server present in listen directive
    if ! grep -q "listen 80 default_server" "${NGINX_CONF}"; then
        sudo sed -i 's/listen 80;/listen 80 default_server;/' "${NGINX_CONF}" || true
    fi
    # Add proxy headers if missing (idempotent)
    if ! grep -q "proxy_set_header Host" "${NGINX_CONF}"; then
        sudo sed -i '/proxy_pass http:\/\/unix:/a\        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;' "${NGINX_CONF}" || true
    fi
    
    # Remove default site if it exists
    if [ -f /etc/nginx/sites-enabled/default ]; then
        sudo rm /etc/nginx/sites-enabled/default
        echo "âœ… Removed default Nginx site"
    fi
fi

# Test and reload nginx safely
sudo nginx -t && sudo systemctl reload nginx
sudo systemctl enable --now nginx
echo "ğŸ” Nginx reloaded."

# --- Step 10: Firewall Rules (UFW) ---
echo "ğŸ›¡ï¸  Ensuring firewall rules..."
if ! sudo ufw status | grep -q "Status: active"; then
    sudo ufw default deny incoming
    sudo ufw default allow outgoing
    sudo ufw allow 22/tcp comment "Allow SSH"
    sudo ufw allow 80/tcp comment "Allow HTTP"
    sudo ufw allow 443/tcp comment "Allow HTTPS"
    sudo ufw --force enable
else
    sudo ufw allow 22/tcp comment "Allow SSH" 2>/dev/null || true
    sudo ufw allow 80/tcp comment "Allow HTTP" 2>/dev/null || true
    sudo ufw allow 443/tcp comment "Allow HTTPS" 2>/dev/null || true
fi
sudo ufw status verbose

# --- Step 11: Healthcheck & diagnostics ---
PUBLIC_IP=$(curl -s http://checkip.amazonaws.com || echo "0.0.0.0")
echo "ğŸ¯ Running application health checks (local)..."
sleep 5  # Increased wait time for services to stabilize
HTTP_CODE_LOCAL=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost/api/schema/" --max-time 10 || echo "000")
HTTP_CODE_EXTERNAL=$(curl -s -o /dev/null -w "%{http_code}" "http://${PUBLIC_IP}/api/schema/" --max-time 10 || echo "000")

echo " - local (localhost) returned HTTP ${HTTP_CODE_LOCAL}"
echo " - external (public IP) returned HTTP ${HTTP_CODE_EXTERNAL}"

if [ "${HTTP_CODE_LOCAL}" = "200" ] || [ "${HTTP_CODE_EXTERNAL}" = "200" ]; then
    echo "âœ… Application appears to be responding."
    echo "   API Schema: http://${PUBLIC_IP}/api/schema/"
    echo "   Swagger UI: http://${PUBLIC_IP}/api/schema/swagger-ui/"
else
    echo "âš ï¸  Health check did not return 200."
    echo ""
    echo "ğŸ” Troubleshooting steps:"
    echo "   1. Check Gunicorn: sudo systemctl status gunicorn"
    echo "   2. Check Nginx: sudo nginx -t && sudo systemctl status nginx"
    echo "   3. Check logs: sudo journalctl -u gunicorn -n 50"
    echo "   4. Verify ALLOWED_HOSTS in ${ENV_FILE} includes your IP (no ports)"
    echo "   5. Check socket permissions: ls -la ${PROJECT_DIR}/${PROJECT_NAME}.sock"
    echo ""
    echo "   Gunicorn status:"
    sudo systemctl status gunicorn --no-pager -l || true
    echo ""
    echo "   Nginx error tail:"
    sudo tail -n 30 /var/log/nginx/error.log || true
    echo ""
    echo "   Gunicorn journal (last 80 lines):"
    sudo journalctl -u gunicorn -n 80 --no-pager || true
fi

# Record deployment version
DEPLOYMENT_VERSION=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
echo "${DEPLOYMENT_VERSION}" > "${PROJECT_DIR}/.deployment_version" 2>/dev/null || true
echo "ğŸ“Œ Deployment version: ${DEPLOYMENT_VERSION}"

echo "ğŸ‰ Deployment script finished!"
echo "âš ï¸ Reminder: Validate and update ${ENV_FILE} (ALLOWED_HOSTS, OPENAI_API_KEY, DB_PASSWORD) as needed."
echo "ğŸŒ Try: http://${PUBLIC_IP}/api/schema/swagger-ui/"

